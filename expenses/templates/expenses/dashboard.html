{% extends 'expenses/base.html' %}


{% block content %}
<div style="padding: 110px 0px 0px 0px; margin-left: 15px;">
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
  {% endif %}
  <h1>Welcome {{request.user.username}}</h1>
  <!-- Your summary box -->
  <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; margin-top:25px; border-radius: 8px;">
    <h2>Your summary</h2>
    <p><strong>üìä Total Expenses:</strong> ‡§∞‡•Å {{total_expense}}</p>
    <p><strong>üìä This Month's Expenses:</strong> ‡§∞‡•Å {{monthly_total}}</p>
    <p><strong>üìä Total Number of Expenses:</strong> {{total_count}}</p>
    <p><strong>üìä Total Number of Expenses this month:</strong> {{month_count}}</p>
  </div>

  <!-- Recent expenses -->
  <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px;">

    <div style="display: flex; justify-content: space-between;">
      <h2>Recent Expenses</h2>
    
      <form action="{% url 'export' %}" method="get">
        <button type="submit" class="btn btn-primary"
          onclick="setTimeout(()=>{alert('Your download has been started')},200)">Export To CSV</button>
      </form>
    </div>
    <hr>
    {% for x in recent_expenses %}
    <h3>{{x.title}}</h3>
    <p><strong>Amount:</strong> ‡§∞‡•Å {{x.amount}}</p>
    <p><strong>Category:</strong> {{x.category}}</p>
    <p><strong>Added date:</strong> {{x.date}}</p>
    <hr>
    {% endfor %}
  </div>

  <!-- Category Summary -->
  <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
    <h2>Expenses By Category</h2>
    {% for item in category_summary %}
    <h3>
      {{ item.category }}
      <span style="float: right;">‡§∞‡•Å {{ item.total }}</span>
    </h3>
    {% empty %}
    <p>No expenses recorded yet.</p>
    {% endfor %}
  </div>

  <!-- Charts -->
  {{ category_labels|json_script:"category-labels" }}
  {{ category_totals|json_script:"category-totals" }}
  {{ month_labels|json_script:"month_labels" }}
  {{ month_totals|json_script:"month_totals" }}

  <div>
    <h1 style="text-align: center;margin-bottom: 50px;">Graphical Visualization of Expenses</h1>
    <div style="display:flex; flex-direction: row; justify-content: space-evenly;">

      <canvas id="donutChart" width="auto" height="500px" style="margin: none;"></canvas>
      <canvas id="barChart" width="auto" height="500px"></canvas>
    </div>

  </div>




  <!-- üîΩ Paste this AFTER the endblock -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const categoryLabels = JSON.parse(document.getElementById('category-labels').textContent);
    const categoryTotals = JSON.parse(document.getElementById('category-totals').textContent);
    const monthLabels = JSON.parse(document.getElementById('month_labels').textContent);
    const monthTotals = JSON.parse(document.getElementById('month_totals').textContent);

    // For donut chart
    const ctx = document.getElementById('donutChart').getContext('2d');

    const data = {
      labels: categoryLabels,
      datasets: [{
        label: 'Expense',
        data: categoryTotals,
        backgroundColor: [
          '#B95C5C',
          '#635CB9',
          '#5CB96C',
          '#B9B95C',
          '#5CB6B9',
          '#5CB6B9'
        ],
        hoverOffset: 4
      }]
    };

    const config = {
      type: 'doughnut',
      data: data,
      options: {
        cutout: '50%',
        responsive: false,
        layout: {
          padding: {
            // top: 50,
            // bottom: 50,
            // left: 50,
            // right: 50,
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Visual Categorization of this Months Expenses'
          }
        }
      }
    };

    new Chart(ctx, config);


    const barCtx = document.getElementById('barChart').getContext('2d');

    new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: monthLabels,
        datasets: [{
          label: 'Monthly Expenses',
          data: monthTotals,
          backgroundColor: '#55BA4E',
          borderColor: '#BA4E55',
          borderWidth: 3
        }]
      },
      options: {
        responsive: false,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          legend: {
            display: true
          },
          title: {
            display: true,
            text: 'Monthly Expense Trend (This Year)'
          }
        }
      }
    });

  </script>


  {% endblock %}